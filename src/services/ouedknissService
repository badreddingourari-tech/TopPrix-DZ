import axios from 'axios';
import * as cheerio from 'cheerio';

export class OuedknissService {
    static async searchProducts(productName) {
        try {
            console.log(`ğŸ” Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ouedkniss Ø¹Ù†: ${productName}`);

            // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ouedkniss
            const response = await axios.get(`https://www.ouedkniss.com/resultat/?text=${encodeURIComponent(productName)}`, {
                headers: {
                    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
                },
                timeout: 10000
            });

            const $ = cheerio.load(response.data);
            const results = [];

            // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª (Ù‡ÙŠÙƒÙ„ Ouedkniss Ø§Ù„Ø­Ø§Ù„ÙŠ)
            $('.annonce_list, .product-item, [class*="annonce"]').each((index, element) => {
                if (index >= 5) return false; // Ø£ÙˆÙ„ 5 Ù†ØªØ§Ø¦Ø¬ ÙÙ‚Ø·

                const title = $(element).find('.titre, .title, h2, h3').first().text().trim();
                const price = $(element).find('.prix, .price, [class*="prix"]').first().text().trim();
                const location = $(element).find('.lieu, .location, [class*="lieu"]').first().text().trim();
                const link = $(element).find('a').first().attr('href');

                if (title && price) {
                    results.push({
                        title,
                        price: price.replace(/\s+/g, ' '),
                        location: location || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
                        link: link ? `https://www.ouedkniss.com${link.startsWith('/') ? link : '/' + link}` : null,
                        source: 'Ouedkniss'
                    });
                }
            });

            console.log(`âœ… ÙˆØ¬Ø¯Ù†Ø§ ${results.length} Ù†ØªÙŠØ¬Ø© Ù…Ù† Ouedkniss`);
            return results;

        } catch (error) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø« Ù…Ù† Ouedkniss:', error.message);
            return [];
        }
    }

    static async getProductDetails(productUrl) {
        try {
            const response = await axios.get(productUrl, {
                headers: {
                    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
                }
            });

            const $ = cheerio.load(response.data);

            return {
                title: $('h1').first().text().trim(),
                price: $('.prix, .price').first().text().trim(),
                description: $('.description, .desc').first().text().trim().substring(0, 200) + '...',
                seller: $('.vendeur, .seller').first().text().trim(),
                phone: $('.telephone, .phone').first().text().trim() || 'ØºÙŠØ± Ù…ØªÙˆÙØ±'
            };
        } catch (error) {
            console.error('Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„ØªÙØ§ØµÙŠÙ„:', error);
            return null;
        }
    }
}
